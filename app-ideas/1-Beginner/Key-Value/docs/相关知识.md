# KeyboardEvent 相关知识

## KeyboardEvent 概述

KeyboardEvent 是 Web API 中用于处理键盘事件的接口，当用户与键盘交互时（按下或释放按键）会触发此事件。

## 主要属性

### 按键识别属性

- **`key`** - 返回按键的字符串值
  - 例如：'a', 'Enter', 'Shift', 'ArrowUp'
  - 对于可打印字符，返回实际字符
  - 对于功能键，返回标准名称

- **`code`** - 返回按键的物理代码
  - 例如：'KeyA', 'Enter', 'ShiftLeft', 'ArrowUp'
  - 不受键盘布局影响，始终表示物理按键位置

- **`keyCode`** (已废弃) - 返回按键的数字代码
  - 建议使用 `key` 或 `code` 替代

### 修饰键状态属性

- **`altKey`** - 布尔值，表示 Alt 键是否被按下
- **`ctrlKey`** - 布尔值，表示 Ctrl 键是否被按下
- **`metaKey`** - 布尔值，表示 Meta 键（Windows 键或 Cmd 键）是否被按下
- **`shiftKey`** - 布尔值，表示 Shift 键是否被按下

### 其他重要属性

- **`type`** - 事件类型（'keydown', 'keyup', 'keypress'）
- **`target`** - 触发事件的元素
- **`timeStamp`** - 事件发生的时间戳
- **`repeat`** - 布尔值，表示按键是否被重复按下
- **`isComposing`** - 布尔值，表示是否在输入法组合过程中

## 主要方法

- **`preventDefault()`** - 阻止事件的默认行为
- **`stopPropagation()`** - 停止事件冒泡

## 事件类型

- **`keydown`** - 按键按下时触发
- **`keyup`** - 按键释放时触发
- **`keypress`** (已废弃) - 按键按下时触发，建议使用 keydown

## 实际应用示例

```javascript
// 监听键盘事件
document.addEventListener('keydown', function(event) {
    console.log('按键值:', event.key);
    console.log('按键代码:', event.code);
    console.log('Alt键状态:', event.altKey);
    console.log('Ctrl键状态:', event.ctrlKey);
    console.log('Meta键状态:', event.metaKey);
    console.log('Shift键状态:', event.shiftKey);
    console.log('是否重复:', event.repeat);
});

// 阻止默认行为
document.addEventListener('keydown', function(event) {
    if (event.key === 'F5') {
        event.preventDefault(); // 阻止页面刷新
    }
});
```

## 常用按键值对照表

| 按键 | key 值 | code 值 |
|------|--------|---------|
| 字母 a | 'a' | 'KeyA' |
| 数字 1 | '1' | 'Digit1' |
| 空格 | ' ' | 'Space' |
| 回车 | 'Enter' | 'Enter' |
| 退格 | 'Backspace' | 'Backspace' |
| 删除 | 'Delete' | 'Delete' |
| 方向键上 | 'ArrowUp' | 'ArrowUp' |
| 方向键下 | 'ArrowDown' | 'ArrowDown' |
| 方向键左 | 'ArrowLeft' | 'ArrowLeft' |
| 方向键右 | 'ArrowRight' | 'ArrowRight' |
| Shift | 'Shift' | 'ShiftLeft' 或 'ShiftRight' |
| Ctrl | 'Control' | 'ControlLeft' 或 'ControlRight' |
| Alt | 'Alt' | 'AltLeft' 或 'AltRight' |
| Meta | 'Meta' | 'MetaLeft' 或 'MetaRight' |

## KeyboardEvent.code 值规则详解

### code 值的命名规则

`code` 值遵循 **W3C 标准**，不是 ASCII 编码，而是一套专门的物理按键标识系统：

#### 1. **字母键规则**
- 格式：`Key` + 大写字母
- 例如：`KeyA`, `KeyB`, `KeyC`, ..., `KeyZ`
- 不受键盘布局影响，始终表示物理位置

#### 2. **数字键规则**
- 格式：`Digit` + 数字
- 例如：`Digit0`, `Digit1`, `Digit2`, ..., `Digit9`
- 主键盘区的数字键

#### 3. **功能键规则**
- 格式：`F` + 数字
- 例如：`F1`, `F2`, `F3`, ..., `F24`
- 键盘顶部的功能键

#### 4. **修饰键规则**
- 左右区分：`ShiftLeft`, `ShiftRight`
- 例如：`ControlLeft`, `ControlRight`, `AltLeft`, `AltRight`, `MetaLeft`, `MetaRight`

#### 5. **方向键规则**
- 格式：`Arrow` + 方向
- 例如：`ArrowUp`, `ArrowDown`, `ArrowLeft`, `ArrowRight`

#### 6. **特殊键规则**
- 空格：`Space`
- 回车：`Enter`
- 退格：`Backspace`
- 删除：`Delete`
- Tab：`Tab`
- 转义：`Escape`
- 大写锁定：`CapsLock`
- 数字锁定：`NumLock`
- 滚动锁定：`ScrollLock`

#### 7. **小键盘规则**
- 数字：`Numpad0`, `Numpad1`, ..., `Numpad9`
- 运算符：`NumpadAdd`, `NumpadSubtract`, `NumpadMultiply`, `NumpadDivide`
- 其他：`NumpadEnter`, `NumpadDecimal`, `NumpadComma`

#### 8. **标点符号键规则**
- 基于物理位置命名
- 例如：`Semicolon`, `Equal`, `Comma`, `Minus`, `Period`, `Slash`, `Backquote`
- 例如：`BracketLeft`, `BracketRight`, `Backslash`, `Quote`

### code 值的特点

1. **物理位置导向**：表示按键在键盘上的物理位置，而不是字符
2. **布局无关**：无论使用什么键盘布局（QWERTY、AZERTY、Dvorak等），code 值都相同
3. **标准化**：遵循 W3C 标准，确保跨浏览器一致性
4. **区分左右**：修饰键会区分左右版本

### 与 ASCII 的区别

| 特性 | ASCII | KeyboardEvent.code |
|------|-------|-------------------|
| 用途 | 字符编码 | 物理按键标识 |
| 范围 | 0-127 | 字符串标识符 |
| 布局影响 | 受键盘布局影响 | 不受布局影响 |
| 示例 | 65 (A的ASCII) | "KeyA" |

## 注意事项

1. **浏览器兼容性**：不同浏览器对某些特殊按键的支持可能不同
2. **输入法**：在使用输入法时，`isComposing` 属性很有用
3. **事件顺序**：keydown → keypress → keyup
4. **修饰键**：修饰键本身也会触发事件
5. **重复按键**：长按时会重复触发 keydown 事件
6. **code vs key**：`code` 表示物理按键，`key` 表示实际字符

## 音频播放相关问题

### Favicon 请求问题

在使用 `Audio()` 构造函数播放音频时，Chrome 浏览器会在每次调用 `.play()` 方法时发送对网站 favicon 的 GET 请求，导致控制台出现 404 错误。

#### 问题表现
```
favicon.ico:1 GET http://127.0.0.1:5525/favicon.ico 404 (Not Found)
```

#### 解决方案

**方案1：添加空的 favicon（推荐）**
```html
<!-- 在 <head> 部分添加 -->
<link rel="icon" href="data:,">
```

**方案2：创建 favicon.ico 文件**
在项目根目录放置一个 favicon.ico 文件

**方案3：音频播放优化**
```javascript
function playSound(audio) {
    audio.currentTime = 0;
    audio.play().catch(error => {
        console.log('音效播放失败:', error);
    });
    // 在音频结束前暂停，避免浏览器请求 favicon
    setTimeout(() => audio.pause(), audio.duration * 999);
}
```

#### 原因分析
这是 Chrome 浏览器的内部行为，当播放音频时会尝试获取网站图标，即使没有显式设置 favicon 也会发送请求。

#### 最佳实践
- 使用方案1（空 favicon）最简单有效
- 不影响音频播放功能
- 避免不必要的网络请求

## 键盘布局处理示例

### 问题场景
当用户按 QWERTY 键盘的 Q 键时，如果用户使用的是 AZERTY 键盘布局，会发生什么？

### 答案：不需要手动转换！

```javascript
// 用户按 QWERTY 键盘的 Q 键位置
document.addEventListener('keydown', function(event) {
    console.log('code 值:', event.code);  // 始终是 "KeyQ"
    console.log('key 值:', event.key);    // 根据布局变化
    
    // QWERTY 布局：key = "q"
    // AZERTY 布局：key = "a" 
    // Dvorak 布局：key = "'"
});
```

### 实际测试结果

| 键盘布局 | 按 QWERTY 的 Q 键位置 | event.code | event.key |
|----------|---------------------|------------|-----------|
| QWERTY   | Q 键                 | "KeyQ"     | "q"       |
| AZERTY   | Q 键位置             | "KeyQ"     | "a"       |
| Dvorak   | Q 键位置             | "KeyQ"     | "'"       |

### 为什么不需要手动转换？

1. **`event.code`** 始终是 `"KeyQ"`，表示物理按键位置
2. **`event.key`** 自动根据当前键盘布局返回正确字符
3. **浏览器自动处理**：浏览器知道当前键盘布局，会自动转换

### 实际应用建议

```javascript
// ✅ 推荐：使用 code 进行物理按键检测
if (event.code === 'KeyQ') {
    // 无论什么布局，都是按的 QWERTY 的 Q 键位置
    console.log('用户按了 QWERTY 的 Q 键位置');
}

// ✅ 推荐：使用 key 进行字符检测
if (event.key === 'q') {
    // 只有 QWERTY 布局才会触发
    console.log('用户输入了字符 q');
}

// ❌ 不推荐：手动转换
if (event.key === 'q') {
    // 在 AZERTY 布局中永远不会触发
    // 因为按 Q 键位置得到的是 'a'
}
```

### 总结
- **不需要手动转换**：浏览器自动处理键盘布局
- **使用 `code`**：检测物理按键位置
- **使用 `key`**：检测实际输入的字符
- **让浏览器处理**：避免复杂的布局转换逻辑

## 组合键检测（如 Ctrl+Q, Alt+1 等）

### 问题场景
如何区分用户输入的是 "q" 还是 "Ctrl+Q"？游戏中的技能快捷键是如何实现的？

### 答案：使用修饰键属性

```javascript
document.addEventListener('keydown', function(event) {
    // 检测修饰键状态
    const isCtrl = event.ctrlKey;
    const isAlt = event.altKey;
    const isShift = event.shiftKey;
    const isMeta = event.metaKey; // Windows键 或 Cmd键
    
    // 检测主按键
    const mainKey = event.key;
    const mainCode = event.code;
    
    // 组合键检测示例
    if (isCtrl && mainKey === 'q') {
        console.log('用户按了 Ctrl+Q');
        // 阻止默认行为（如关闭浏览器）
        event.preventDefault();
    }
    
    if (isAlt && mainCode === 'Digit1') {
        console.log('用户按了 Alt+1');
        // 游戏技能快捷键
    }
    
    if (isCtrl && isAlt && mainKey === 'f') {
        console.log('用户按了 Ctrl+Alt+F');
        // 复杂组合键
    }
});
```

### 实际应用示例（类似魔兽世界）

```javascript
// 游戏技能快捷键系统
const skillKeys = {
    'Digit1': '技能1',
    'Digit2': '技能2',
    'Digit3': '技能3',
    'KeyQ': 'Q技能',
    'KeyE': 'E技能',
    'KeyR': 'R技能'
};

document.addEventListener('keydown', function(event) {
    const key = event.key;
    const code = event.code;
    
    // 检测组合键
    if (event.ctrlKey && event.altKey) {
        // Ctrl+Alt+数字/字母
        if (skillKeys[code]) {
            console.log(`释放技能: ${skillKeys[code]} (Ctrl+Alt+${key})`);
            event.preventDefault();
        }
    } else if (event.ctrlKey) {
        // Ctrl+数字/字母
        if (skillKeys[code]) {
            console.log(`释放技能: ${skillKeys[code]} (Ctrl+${key})`);
            event.preventDefault();
        }
    } else if (event.altKey) {
        // Alt+数字/字母
        if (skillKeys[code]) {
            console.log(`释放技能: ${skillKeys[code]} (Alt+${key})`);
            event.preventDefault();
        }
    } else {
        // 单独按键
        if (skillKeys[code]) {
            console.log(`释放技能: ${skillKeys[code]} (${key})`);
            event.preventDefault();
        }
    }
});
```

### 修饰键检测表

| 组合键 | 检测条件 | 示例 |
|--------|----------|------|
| Ctrl+Q | `event.ctrlKey && event.key === 'q'` | 关闭应用 |
| Alt+Tab | `event.altKey && event.key === 'Tab'` | 切换窗口 |
| Shift+A | `event.shiftKey && event.key === 'A'` | 大写A |
| Ctrl+Alt+Delete | `event.ctrlKey && event.altKey && event.key === 'Delete'` | 系统快捷键 |
| Cmd+C (Mac) | `event.metaKey && event.key === 'c'` | 复制 |

### 游戏快捷键系统实现

```javascript
class GameHotkeySystem {
    constructor() {
        this.hotkeys = new Map();
        this.setupEventListeners();
    }
    
    // 注册快捷键
    registerHotkey(combination, callback) {
        this.hotkeys.set(combination, callback);
    }
    
    // 设置事件监听
    setupEventListeners() {
        document.addEventListener('keydown', (event) => {
            const combination = this.getKeyCombination(event);
            const callback = this.hotkeys.get(combination);
            
            if (callback) {
                event.preventDefault();
                callback();
            }
        });
    }
    
    // 获取按键组合字符串
    getKeyCombination(event) {
        const modifiers = [];
        if (event.ctrlKey) modifiers.push('Ctrl');
        if (event.altKey) modifiers.push('Alt');
        if (event.shiftKey) modifiers.push('Shift');
        if (event.metaKey) modifiers.push('Meta');
        
        const mainKey = event.key;
        return modifiers.length > 0 ? 
            `${modifiers.join('+')}+${mainKey}` : 
            mainKey;
    }
}

// 使用示例
const game = new GameHotkeySystem();

// 注册技能快捷键
game.registerHotkey('Ctrl+1', () => console.log('释放技能1'));
game.registerHotkey('Alt+Q', () => console.log('释放技能Q'));
game.registerHotkey('Ctrl+Alt+R', () => console.log('释放大招R'));
```

### 注意事项

1. **阻止默认行为**：使用 `event.preventDefault()` 防止浏览器默认行为
2. **事件冒泡**：使用 `event.stopPropagation()` 防止事件传播
3. **浏览器差异**：某些系统快捷键可能无法被阻止
4. **用户体验**：避免与浏览器默认快捷键冲突
